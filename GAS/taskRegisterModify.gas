/**
 * =====================================================
 *  è»Šä¸¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - GAS çµ±åˆç‰ˆ
 *  å½¹å‰²ï¼š
 *    1. doGet      : Webãƒšãƒ¼ã‚¸ã¸ã®APIæä¾› (ç¤¾å“¡ç”¨ / é¡§å®¢ç”¨)
 *    2. ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç† : ç™»éŒ²ãƒ»ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚’å—ã‘ã¦ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° â†’ LINEé€šçŸ¥
 *    3. æœŸæ—¥ãƒã‚§ãƒƒã‚¯ : æ¯æ—¥9æ™‚ã«è»Šæ¤œãƒ»ã‚ªã‚¤ãƒ«äº¤æ›ã®æœŸæ—¥ã‚’ç¢ºèª â†’ LINEé€šçŸ¥
 *
 *  Make ã®å½¹å‰²ï¼šGASã‹ã‚‰å±Šã„ãŸLINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’LINEã«é€ä¿¡ã™ã‚‹ã ã‘
 * =====================================================
 */

// =====================================================
//  â˜… è¨­å®šã‚¨ãƒªã‚¢ï¼ˆã“ã“ã ã‘æ›¸ãæ›ãˆã‚Œã°OKï¼‰
// =====================================================

const CONFIG = {

  // --- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ ---
  SPREADSHEET_ID: '1wAfgpOuhMXWciuxr7aKCEHtI6qNbFbRE2CSzytFMr4M',
  SHEET: {
    MASTER:        'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿',
    REGISTER_LOG:  'ç™»éŒ²ã‚·ãƒ¼ãƒˆ',
    MODIFY_LOG:    'ä¿®æ­£ã‚·ãƒ¼ãƒˆ',
  },

  // --- Make Webhook ---
  // é€šçŸ¥å…ˆã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã¯Makeå´ã§è¡Œã„ã¾ã™ã€‚GASå´ã®æŒ‡å®šã¯ä¸è¦ã§ã™ã€‚
  WEBHOOK_URL: 'https://hook.eu2.make.com/my8kvc5qb6n56of4denemgr9q5r8rpb1',

  // --- é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆæ—¥æ•°ï¼‰ ---
  NOTIFICATION_DAYS: {
    VEHICLE_INSPECTION: [60, 30, 21], // è»Šæ¤œæº€äº†æ—¥ï¼š2ã‹æœˆå‰(60æ—¥)ãƒ»1ã‹æœˆå‰(30æ—¥)ãƒ»3é€±é–“å‰(21æ—¥)
    OIL_CHANGE:         [7,  0],      // ã‚ªã‚¤ãƒ«äº¤æ›æ—¥ï¼š1é€±é–“å‰(7æ—¥)ãƒ»å½“æ—¥(0æ—¥)
  },
};

// =====================================================
//  ã‚¹ãƒ—ã‚·ã®ãƒ˜ãƒƒãƒ€ãƒ¼å â†’ åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°
//  â€» ã‚¹ãƒ—ã‚·ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ä¸€è‡´ã•ã›ã¦ãã ã•ã„
// =====================================================

/**
 * ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®åˆ—åå®šç¾©
 * å®Ÿéš›ã®ã‚¹ãƒ—ã‚·ãƒ˜ãƒƒãƒ€ãƒ¼ï¼š
 *   ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— | è‡ªå‹•è»ŠãƒŠãƒ³ãƒãƒ¼ | è²¸å‡ºå…ˆ | ä½¿ç”¨è€… | è»Šå°ç•ªå· | æ‰€æœ‰è€… |
 *   ä»»æ„ä¿é™º | çŠ¶æ…‹ | è²¸å‡ºå…ˆ/ã‚¨ãƒªã‚¢ | è»Šæ¤œæº€äº†æ—¥ | ã‚ªã‚¤ãƒ«äº¤æ›æ—¥ |
 *   ãƒ¬ãƒ³ã‚¿ãƒ«æ–™é‡‘ï¼ˆä¾‹ï¼š15000ï¼‰ | è»Šä¸¡ç”»åƒ
 */
const COL = {
  TIMESTAMP:   'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—',
  PLATE:       'è‡ªå‹•è»ŠãƒŠãƒ³ãƒãƒ¼',
  CARMODEL:    'è»Šç¨®',            // â˜…è¿½åŠ 
  LOAN_DEST:   'è²¸å‡ºå…ˆ',
  USER:        'ä½¿ç”¨è€…',
  CHASSIS:     'è»Šå°ç•ªå·',
  OWNER:       'æ‰€æœ‰è€…',
  INSURANCE:   'ä»»æ„ä¿é™º',
  STATUS:      'çŠ¶æ…‹',
  AREA:        'è²¸å‡ºå…ˆ/ã‚¨ãƒªã‚¢',
  INSPECTION:  'è»Šæ¤œæº€äº†æ—¥',
  OIL:         'ã‚ªã‚¤ãƒ«äº¤æ›æ—¥',
  PRICE:       'ãƒ¬ãƒ³ã‚¿ãƒ«æ–™é‡‘ï¼ˆä¾‹ï¼š15000ï¼‰',
  IMAGE:       'è»Šä¸¡ç”»åƒ',
};

// ãƒ•ã‚©ãƒ¼ãƒ ã®è³ªå•å â†’ COLã‚­ãƒ¼ ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ ã®å·®åˆ†æ›´æ–°ã§ä½¿ç”¨ï¼‰
const FORM_TO_COL = {
  'è‡ªå‹•è»ŠãƒŠãƒ³ãƒãƒ¼':            COL.PLATE,
  'è²¸å‡ºå…ˆ':                    COL.LOAN_DEST,
  'ä½¿ç”¨è€…':                    COL.USER,
  'è»Šå°ç•ªå·':                  COL.CHASSIS,
  'æ‰€æœ‰è€…':                    COL.OWNER,
  'ä»»æ„ä¿é™º':                  COL.INSURANCE,
  'çŠ¶æ…‹':                      COL.STATUS,
  'è²¸å‡ºå…ˆ/ã‚¨ãƒªã‚¢':             COL.AREA,
  'è»Šæ¤œæº€äº†æ—¥':                COL.INSPECTION,
  'ã‚ªã‚¤ãƒ«äº¤æ›æ—¥':              COL.OIL,
  'ãƒ¬ãƒ³ã‚¿ãƒ«æ–™é‡‘ï¼ˆä¾‹ï¼š15000ï¼‰': COL.PRICE,
  'è»Šä¸¡ç”»åƒ':                  COL.IMAGE,
};


// =====================================================
//  1. doGet : Webãƒšãƒ¼ã‚¸ç”¨API
// =====================================================

function doGet(e) {
  const role = (e && e.parameter) ? e.parameter.role : null;

  try {
    const vehicles = _getMasterData();

    let responseData;
    if (role === 'client') {
      // é¡§å®¢ç”¨ï¼šå¿…è¦æœ€å°é™ã®é …ç›®ã®ã¿è¿”ã™
      responseData = vehicles.map(car => ({
        id:         car.id,
        carModel:   car.carModel,  // é¡§å®¢å‘ã‘ã¯è»Šç¨®
        price:      car.price,
        area:       car.area,
        status:     car.status === 'è²©å£²å¯' ? 'è²¸å‡ºå¯' : 'è²¸å‡ºä¸å¯',
        images:     car.images,
        inspection: car.inspection,  // è»Šæ¤œæº€äº†æ—¥ï¼ˆé¡§å®¢å‘ã‘ã«è¿½åŠ ï¼‰
      }));
    } else {
      // ç¤¾å“¡ç”¨ï¼šå…¨é …ç›®è¿”ã™
      responseData = vehicles;
    }

    return _jsonResponse(responseData);

  } catch (err) {
    Logger.log('doGet ã‚¨ãƒ©ãƒ¼: ' + err.message);
    return _jsonResponse({ error: err.message });
  }
}


// =====================================================
//  2. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
// =====================================================

/**
 * ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
 * ã‚¹ãƒ—ã‚·å´ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼šã€Œãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã€â†’ onFormSubmitRegister
 */
function onFormSubmitRegister(e) {
  _handleFormSubmit(e, 'REGISTER');
}

/**
 * ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
 * ã‚¹ãƒ—ã‚·å´ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼šã€Œãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã€â†’ onFormSubmitModify
 */
function onFormSubmitModify(e) {
  _handleFormSubmit(e, 'MODIFY');
}

function _handleFormSubmit(e, type) {
  if (!e || !e.namedValues) {
    Logger.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯æ‰‹å‹•ã§ãƒ€ãƒŸãƒ¼ã‚’æ¸¡ã—ã¦ãã ã•ã„ï¼‰');
    return;
  }

  const formResponse = e.namedValues;
  const ss           = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const masterSheet  = ss.getSheetByName(CONFIG.SHEET.MASTER);
  if (!masterSheet) throw new Error('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

  // ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
  const plate = _getFormValue(formResponse, 'è‡ªå‹•è»ŠãƒŠãƒ³ãƒãƒ¼');
  if (!plate) {
    Logger.log('è‡ªå‹•è»ŠãƒŠãƒ³ãƒãƒ¼ãŒç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
    return;
  }

  const allData  = masterSheet.getDataRange().getValues();
  const headers  = allData[0];
  const colIndex = (colName) => headers.indexOf(colName); // ãƒ˜ãƒƒãƒ€ãƒ¼å â†’ åˆ—ç•ªå·

  // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“è¡Œã‚’æ¤œç´¢
  let rowIndex = -1;
  const plateCol = colIndex(COL.PLATE);
  for (let i = 1; i < allData.length; i++) {
    if (String(allData[i][plateCol]) === String(plate)) {
      rowIndex = i;
      break;
    }
  }

  // ç™»éŒ² or ä¿®æ­£ã®åˆ†å²
  if (type === 'REGISTER' && rowIndex !== -1) {
    _sendLineMessage(`âš ï¸ ç™»éŒ²ã‚¹ã‚­ãƒƒãƒ—\nãƒŠãƒ³ãƒãƒ¼ã€Œ${plate}ã€ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚`);
    return;
  }
  if (type === 'MODIFY' && rowIndex === -1) {
    _sendLineMessage(`âš ï¸ ä¿®æ­£ã‚¹ã‚­ãƒƒãƒ—\nãƒŠãƒ³ãƒãƒ¼ã€Œ${plate}ã€ã¯ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
    return;
  }

  // æ›¸ãè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
  const newRow = type === 'REGISTER'
    ? new Array(headers.length).fill('')
    : [...allData[rowIndex]];

  if (type === 'REGISTER') {
    newRow[colIndex(COL.TIMESTAMP)] = new Date();
  }

  const changedItems = [];

  // ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦é©ç”¨
  for (const question in formResponse) {
    const colName = _matchFormKey(question);
    if (!colName) continue;

    const idx = colIndex(colName);
    if (idx === -1) continue;

    const rawVal = formResponse[question][0];
    if (!rawVal && rawVal !== 0) continue;

    const newVal = rawVal instanceof Date
      ? Utilities.formatDate(rawVal, Session.getScriptTimeZone(), 'yyyy/MM/dd')
      : String(rawVal);

    const oldVal = newRow[idx];
    if (String(oldVal) !== newVal) {
      changedItems.push(`ãƒ»${colName}ï¼š${oldVal || 'ï¼ˆç©ºæ¬„ï¼‰'} â†’ ${newVal}`);
      newRow[idx] = newVal;
    }
  }

  // ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
  if (type === 'REGISTER') {
    masterSheet.appendRow(newRow);
  } else if (changedItems.length > 0) {
    masterSheet.getRange(rowIndex + 1, 1, 1, newRow.length).setValues([newRow]);
  }

  // LINEé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ„ã¿ç«‹ã¦
  let message = '';
  if (type === 'REGISTER') {
    message =
      `ğŸš— è»Šä¸¡ç™»éŒ²å®Œäº†\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `ãƒŠãƒ³ãƒãƒ¼ï¼š${plate}\n` +
      `çŠ¶æ…‹ã€€ã€€ï¼š${newRow[colIndex(COL.STATUS)] || 'æœªè¨­å®š'}\n` +
      `ã‚¨ãƒªã‚¢ã€€ï¼š${newRow[colIndex(COL.AREA)]   || 'æœªè¨­å®š'}\n` +
      `ç™»éŒ²æ—¥æ™‚ï¼š${Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm')}`;
  } else if (changedItems.length > 0) {
    message =
      `âœï¸ è»Šä¸¡æƒ…å ±æ›´æ–°\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `ãƒŠãƒ³ãƒãƒ¼ï¼š${plate}\n` +
      `å¤‰æ›´å†…å®¹ï¼š\n${changedItems.join('\n')}`;
  } else {
    Logger.log('å¤‰æ›´ãªã—ï¼šé€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—');
    return;
  }

  _sendLineMessage(message);
  Logger.log(`${type} å‡¦ç†å®Œäº†: ${plate}`);
}


// =====================================================
//  3. æœŸæ—¥ãƒã‚§ãƒƒã‚¯ï¼ˆæ¯æ—¥9æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
// =====================================================

/**
 * ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼šæ™‚é–“ãƒ™ãƒ¼ã‚¹ â†’ æ¯æ—¥ â†’ åˆå‰9æ™‚
 * é–¢æ•°å: checkDueDates
 */
function checkDueDates() {
  Logger.log('--- æœŸæ—¥ãƒã‚§ãƒƒã‚¯é–‹å§‹ ---');

  const ss    = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet = ss.getSheetByName(CONFIG.SHEET.MASTER);
  if (!sheet) return;

  const data    = sheet.getDataRange().getValues();
  const headers = data[0];
  const colIdx  = (name) => headers.indexOf(name);

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é€šçŸ¥ã‚’ã¾ã¨ã‚ã‚‹
  const alerts = {
    inspection: [], // è»Šæ¤œæº€äº†æ—¥
    oil:        [], // ã‚ªã‚¤ãƒ«äº¤æ›æ—¥
  };

  for (let i = 1; i < data.length; i++) {
    const row   = data[i];
    const plate = row[colIdx(COL.PLATE)];
    if (!plate) continue;

    // è»Šæ¤œæº€äº†æ—¥ãƒã‚§ãƒƒã‚¯
    const inspectionDate = row[colIdx(COL.INSPECTION)];
    if (inspectionDate) {
      const target = _toDate(inspectionDate);
      if (target) {
        const diffDays = _daysDiff(today, target);
        if (CONFIG.NOTIFICATION_DAYS.VEHICLE_INSPECTION.includes(diffDays)) {
          alerts.inspection.push(
            `ãƒ»${plate}ã€€${diffDays === 0 ? 'ã€å½“æ—¥ã€‘' : `ã‚ã¨${diffDays}æ—¥`}ã€€æœŸæ—¥ï¼š${_formatDate(target)}`
          );
        }
      }
    }

    // ã‚ªã‚¤ãƒ«äº¤æ›æ—¥ãƒã‚§ãƒƒã‚¯
    const oilDate = row[colIdx(COL.OIL)];
    if (oilDate) {
      const target = _toDate(oilDate);
      if (target) {
        const diffDays = _daysDiff(today, target);
        if (CONFIG.NOTIFICATION_DAYS.OIL_CHANGE.includes(diffDays)) {
          alerts.oil.push(
            `ãƒ»${plate}ã€€${diffDays === 0 ? 'ã€å½“æ—¥ã€‘' : `ã‚ã¨${diffDays}æ—¥`}ã€€æœŸæ—¥ï¼š${_formatDate(target)}`
          );
        }
      }
    }
  }

  const totalCount = alerts.inspection.length + alerts.oil.length;

  if (totalCount === 0) {
    Logger.log('æœ¬æ—¥ã®é€šçŸ¥å¯¾è±¡ãªã—');
    Logger.log('--- æœŸæ—¥ãƒã‚§ãƒƒã‚¯çµ‚äº† ---');
    return;
  }

  // 1é€šã«ã¾ã¨ã‚ã¦é€ä¿¡
  const dateStr = Utilities.formatDate(today, Session.getScriptTimeZone(), 'yyyy/MM/dd');
  const lines   = [`ğŸ“‹ æœ¬æ—¥ã®æœŸæ—¥é€šçŸ¥ã€€${dateStr}`, `â”â”â”â”â”â”â”â”â”â”â”â”â”â”`];

  if (alerts.inspection.length > 0) {
    lines.push(`ğŸš— è»Šæ¤œæº€äº†æ—¥ï¼ˆ${alerts.inspection.length}ä»¶ï¼‰`);
    alerts.inspection.forEach(l => lines.push(l));
  }

  if (alerts.inspection.length > 0 && alerts.oil.length > 0) {
    lines.push(''); // ã‚«ãƒ†ã‚´ãƒªé–“ã®ç©ºè¡Œ
  }

  if (alerts.oil.length > 0) {
    lines.push(`â›½ ã‚ªã‚¤ãƒ«äº¤æ›æ—¥ï¼ˆ${alerts.oil.length}ä»¶ï¼‰`);
    alerts.oil.forEach(l => lines.push(l));
  }

  _sendLineMessage(lines.join('\n'));
  Logger.log(`é€šçŸ¥é€ä¿¡: åˆè¨ˆ${totalCount}ä»¶ã‚’1é€šã«ã¾ã¨ã‚ã¦é€ä¿¡`);
  Logger.log('--- æœŸæ—¥ãƒã‚§ãƒƒã‚¯çµ‚äº† ---');
}


// =====================================================
//  4. ãƒˆãƒªã‚¬ãƒ¼è‡ªå‹•è¨­å®šï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
// =====================================================

/**
 * ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿…è¦ãªãƒˆãƒªã‚¬ãƒ¼ã‚’ä¸€æ‹¬è¨­å®šã—ã¾ã™ã€‚
 * GASã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰æ‰‹å‹•ã§1å›ã ã‘å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
 */
function setupTriggers() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å…¨å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));

  // æ¯æ—¥9æ™‚ã«æœŸæ—¥ãƒã‚§ãƒƒã‚¯
  ScriptApp.newTrigger('checkDueDates')
    .timeBased()
    .everyDays(1)
    .atHour(9)
    .create();

  Logger.log('ãƒˆãƒªã‚¬ãƒ¼è¨­å®šå®Œäº†ï¼šcheckDueDates â†’ æ¯æ—¥9æ™‚');
  Logger.log('â€» ç™»éŒ²ãƒ»ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒˆãƒªã‚¬ãƒ¼ã¯ã‚¹ãƒ—ã‚·å´ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
}


// =====================================================
//  ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆé–¢æ•°ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ãƒ»é–¢æ•°åã¯ _ ã§å§‹ã‚ã‚‹ï¼‰
// =====================================================

/**
 * ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦é…åˆ—ã§è¿”ã™
 */
function _getMasterData() {
  const ss      = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet   = ss.getSheetByName(CONFIG.SHEET.MASTER);
  if (!sheet) throw new Error(`ã‚·ãƒ¼ãƒˆ "${CONFIG.SHEET.MASTER}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);

  const data    = sheet.getDataRange().getValues();
  if (data.length <= 1) throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã¿ï¼‰');

  const headers  = data[0];
  const colIdx   = (name) => headers.indexOf(name);

  const vehicles = [];
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (!row[colIdx(COL.PLATE)]) continue; // ãƒŠãƒ³ãƒãƒ¼ãŒç©ºã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—

    const folderId = row[colIdx(COL.IMAGE)];
    const images   = _getImagesFromFolder(folderId);
    const rawPrice = row[colIdx(COL.PRICE)];

    vehicles.push({
      id:            i,
      plateNumber:   row[colIdx(COL.PLATE)]      || '',
      carModel:      row[colIdx(COL.CARMODEL)]   || '', // è»Šç¨®
      loanDest:      row[colIdx(COL.LOAN_DEST)]   || '', // è²¸å‡ºå…ˆ
      chassisNumber: row[colIdx(COL.CHASSIS)]    || '', // ç¤¾å“¡å‘ã‘ï¼šè»Šå°ç•ªå·
      owner:         row[colIdx(COL.OWNER)]      || '',
      user:          row[colIdx(COL.USER)]        || '',
      insurance:     row[colIdx(COL.INSURANCE)]  || '',
      status:        row[colIdx(COL.STATUS)]     || '',
      area:          row[colIdx(COL.AREA)]        || '',
      inspection:    _formatDate(_toDate(row[colIdx(COL.INSPECTION)])),
      oil:           _formatDate(_toDate(row[colIdx(COL.OIL)])),
      price:         rawPrice !== '' ? Number(rawPrice) : '', // æ•°å€¤ã§è¿”ã™
      images:        images,
    });
  }

  return vehicles;
}

/**
 * Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ç”»åƒURLã‚’å–å¾—
 */
function _getImagesFromFolder(folderId) {
  if (!folderId) return ['https://placehold.co/400x300/e5e7eb/6b7280?text=No+Image'];

  try {
    const folder     = DriveApp.getFolderById(String(folderId).trim());
    const files      = folder.getFiles();
    const extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
    const urls       = [];

    while (files.hasNext()) {
      const file = files.next();
      const name = file.getName().toLowerCase();
      if (extensions.some(ext => name.endsWith('.' + ext))) {
        urls.push(`https://drive.google.com/thumbnail?id=${file.getId()}&sz=w800`);
      }
      if (urls.length >= 20) break; // æœ€å¤§20æš
    }

    return urls.length > 0
      ? urls
      : ['https://placehold.co/400x300/e5e7eb/6b7280?text=No+Image'];

  } catch (err) {
    Logger.log('ç”»åƒå–å¾—ã‚¨ãƒ©ãƒ¼: ' + err.message);
    return ['https://placehold.co/400x300/e5e7eb/6b7280?text=Error'];
  }
}

/**
 * Makeã®Webhookã«LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
 * Makeå´ã®ã‚·ãƒŠãƒªã‚ªï¼šWebhookã§å—ã‘å–ã‚Š â†’ LINEã®ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€ã« lineMessage ã‚’æ¸¡ã™ã ã‘
 */
function _sendLineMessage(text) {
  try {
    const payload = {
      lineMessage: text,
      timestamp:   new Date().toISOString(),
    };

    UrlFetchApp.fetch(CONFIG.WEBHOOK_URL, {
      method:          'POST',
      contentType:     'application/json',
      payload:         JSON.stringify(payload),
      muteHttpExceptions: true,
    });

    Logger.log('LINEé€šçŸ¥é€ä¿¡å®Œäº†: ' + text.split('\n')[0]); // 1è¡Œç›®ã ã‘ãƒ­ã‚°
  } catch (err) {
    Logger.log('LINEé€šçŸ¥é€ä¿¡å¤±æ•—: ' + err.message);
  }
}

/**
 * ãƒ•ã‚©ãƒ¼ãƒ ã®è³ªå•åï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰ã‹ã‚‰COLã®ãƒ˜ãƒƒãƒ€ãƒ¼åã‚’è¿”ã™
 */
function _matchFormKey(question) {
  for (const key in FORM_TO_COL) {
    if (question.includes(key)) return FORM_TO_COL[key];
  }
  return null;
}

/**
 * namedValuesã‹ã‚‰æŒ‡å®šã‚­ãƒ¼ã®å€¤ã‚’å–å¾—ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
 */
function _getFormValue(namedValues, keyword) {
  for (const key in namedValues) {
    if (key.includes(keyword)) {
      const val = namedValues[key][0];
      return val ? String(val).trim() : null;
    }
  }
  return null;
}

/**
 * æ—¥ä»˜æ–‡å­—åˆ— or Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå¤±æ•—æ™‚ã¯nullï¼‰
 */
function _toDate(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  const d = new Date(val);
  return isNaN(d.getTime()) ? null : d;
}

/**
 * Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ 'yyyy-MM-dd' æ–‡å­—åˆ—
 */
function _formatDate(date) {
  if (!date) return '';
  return Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd');
}

/**
 * today ã‹ã‚‰ target ã¾ã§ä½•æ—¥å¾Œã‹ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯éå»ï¼‰
 */
function _daysDiff(today, target) {
  const diff = target.getTime() - today.getTime();
  return Math.round(diff / (1000 * 60 * 60 * 24));
}

/**
 * JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆCORSãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãï¼‰
 */
function _jsonResponse(data) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}
